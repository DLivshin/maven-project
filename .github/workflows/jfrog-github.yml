name: "Release Build & Candidate"
on: push

permissions:
  id-token: write
  contents: read

env:
  BUILD_NAME: TestApplication
  # Unique release version for every build
  VERSION: "1.0.${{ github.run_number }}"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ vars.JF_URL }}
        with:
          oidc-provider-name: DLivshin/maven-project@github

      - name: Setup Java & Maven 3.8.8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'
      
      - name: Force Maven 3.8.8
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: '3.8.8'

      - name: Configure for Dev
        run: |
          # We deploy to a 'dev' repo first
          jf mvnc --repo-resolve-releases=example-libs-release --repo-deploy-releases=example-libs-release

      - name: Build and Deploy Release JAR
        run: |
          # 1. Update the POM version to match our unique release
          jf mvn versions:set -DnewVersion="${{ env.VERSION }}" -DgenerateBackupPoms=false
          
          # 2. Deploy the immutable Release JAR to the Dev repo
          jf mvn clean deploy --build-name="${{ env.BUILD_NAME }}" --build-number="${{ env.VERSION }}"

      - name: Upload Assets
        run: |
          # Tag the assets with the same build metadata
          jf rt upload "assets/*" "generic-dev-local/${{ env.VERSION }}/" \
            --build-name="${{ env.BUILD_NAME }}" \
            --build-number="${{ env.VERSION }}"

      - name: Publish Build Info
        run: jf rt build-publish "${{ env.BUILD_NAME }}" "${{ env.VERSION }}"
